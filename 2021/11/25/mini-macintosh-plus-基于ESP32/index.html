<!DOCTYPE html><html lang="zh"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no,minimal-ui"><meta name="renderer" content="webkit"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="format-detection" content="telephone=no,email=no,adress=no"><meta name="theme-color" content="#000000"><meta http-equiv="window-target" content="_top"><title>mini Macintosh plus(基于ESP32) | &#39; J &#39;</title><meta name="description" content="参考：Sprites mods - Miniature Macintosh Plus - Intro  Intro  Back in the early days of computing, there was a company called Apple. They just had great success with their Apple II line of computers, bu"><meta property="og:type" content="article"><meta property="og:title" content="mini Macintosh plus(基于ESP32)"><meta property="og:url" content="https://ljweb.xyz/2021/11/25/mini-macintosh-plus-%E5%9F%BA%E4%BA%8EESP32/index.html"><meta property="og:site_name" content="clock"><meta property="og:description" content="参考：Sprites mods - Miniature Macintosh Plus - Intro  Intro  Back in the early days of computing, there was a company called Apple. They just had great success with their Apple II line of computers, bu"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://spritesmods.com/minimacplus/mac_teaser.png"><meta property="og:image" content="https://spritesmods.com/minimacplus/oled_taobao.png"><meta property="og:image" content="https://spritesmods.com/minimacplus/mipi_signal-tmb.png"><meta property="og:image" content="https://spritesmods.com/minimacplus/schematic_oledpsu-tmb.png"><meta property="og:image" content="https://spritesmods.com/minimacplus/schematic_audio-tmb.png"><meta property="og:image" content="https://spritesmods.com/minimacplus/schematic_mouse-tmb.png"><meta property="og:image" content="https://spritesmods.com/minimacplus/schematic_oledclkdata-tmb.png"><meta property="og:image" content="https://spritesmods.com/minimacplus/pcbs_empty-tmb.jpg"><meta property="og:image" content="https://spritesmods.com/minimacplus/pcb_populated-tmb.jpg"><meta property="og:image" content="https://spritesmods.com/minimacplus/mousesensor-tmb.jpg"><meta property="og:image" content="https://spritesmods.com/minimacplus/mac_poster-tmb.jpg"><meta property="og:image" content="https://spritesmods.com/minimacplus/tme_booted-tmb.png"><meta property="og:image" content="https://spritesmods.com/minimacplus/mac_wroom-tmb.jpg"><meta property="og:image" content="https://spritesmods.com/minimacplus/pixels-tmb.jpg"><meta property="og:image" content="https://spritesmods.com/minimacplus/disp_scaled_tmb.jpg"><meta property="og:image" content="https://spritesmods.com/minimacplus/scad-tmb.jpg"><meta property="og:image" content="https://spritesmods.com/minimacplus/scad_mouse-tmb.png"><meta property="og:image" content="https://spritesmods.com/minimacplus/case_done_tmb.jpg"><meta property="og:image" content="https://spritesmods.com/minimacplus/done-tmb.jpg"><meta property="og:image" content="https://spritesmods.com/minimacplus/tiny_tmb.jpg"><meta property="og:image" content="https://spritesmods.com/minimacplus/mac_full2_tmb.jpg"><meta property="og:image" content="https://spritesmods.com/minimacplus/toaster-optimized.gif"><meta property="article:published_time" content="2021-11-25T12:54:21.000Z"><meta property="article:modified_time" content="2022-02-16T14:10:43.384Z"><meta property="article:author" content="John Doe"><meta property="article:tag" content="diy"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://spritesmods.com/minimacplus/mac_teaser.png"><link rel="canonical" href="https://ljweb.xyz/2021/11/25/mini-macintosh-plus-%E5%9F%BA%E4%BA%8EESP32/index.html"><link rel="alternate" href="/atom.xml" title="clock" type="application/atom+xml"><link rel="icon" href="/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link href="//cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.3.5/dist/jquery.fancybox.min.css" rel="stylesheet"><meta name="generator" content="Hexo 5.4.0"></head><body class="main-center" itemscope itemtype="http://schema.org/WebPage"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="slimContent"><div class="navbar-header"><div class="profile-block text-center"><a id="avatar" href="https://github.com/0clock" target="_blank"><img class="img-rounded" style="border-radius:14px;background-color:transparent" src="/images/avatar.jpg" width="200" height="200"></a><h2 id="name" class="hidden-xs hidden-sm">&#39; J &#39;</h2><h3 id="title" class="hidden-xs hidden-sm hidden-md">生命在于折腾</h3></div><div class="search" id="search-form-wrap"><form class="search-form sidebar-form"><div class="input-group"><input type="text" class="search-form-input form-control" placeholder="搜索"> <span class="input-group-btn"><button type="submit" class="search-form-submit btn btn-flat" onclick="return!1"><i class="icon icon-search"></i></button></span></div></form><div class="ins-search"><div class="ins-search-mask"></div><div class="ins-search-container"><div class="ins-input-wrapper"><input type="text" class="ins-search-input" placeholder="想要查找什么..." x-webkit-speech> <button type="button" class="close ins-close ins-selectable" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button></div><div class="ins-section-wrapper"><div class="ins-section-container"></div></div></div></div></div><button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false"><span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span></button></div><nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation"><ul class="nav navbar-nav main-nav menu-highlight"><li class="menu-item menu-item-home"><a href="/."><i class="icon icon-home-fill"></i> <span class="menu-title">首页</span></a></li><li class="menu-item menu-item-archives"><a href="/archives"><i class="icon icon-archives-fill"></i> <span class="menu-title">归档</span></a></li><li class="menu-item menu-item-categories"><a href="/categories"><i class="icon icon-folder"></i> <span class="menu-title">分类</span></a></li><li class="menu-item menu-item-tags"><a href="/tags"><i class="icon icon-tags"></i> <span class="menu-title">标签</span></a></li><li class="menu-item menu-item-repository"><a href="/repository"><i class="icon icon-project"></i> <span class="menu-title">项目</span></a></li><li class="menu-item menu-item-links"><a href="/links"><i class="icon icon-friendship"></i> <span class="menu-title">友链</span></a></li><li class="menu-item menu-item-about"><a href="/about"><i class="icon icon-cup-fill"></i> <span class="menu-title">关于</span></a></li></ul><ul class="social-links"><li><a href="https://github.com/0clock" target="_blank" title="Github" data-toggle="tooltip" data-placement="top"><i class="icon icon-github"></i></a></li><li><a href="/atom.xml" target="_blank" title="Rss" data-toggle="tooltip" data-placement="top"><i class="icon icon-rss"></i></a></li></ul></nav></div></header><aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar"><div class="slimContent"><div class="widget"><h3 class="widget-title">公告</h3><div class="widget-body"><div id="board"><div class="content"><p>怕什么真理无穷，进一寸有一寸的欢喜</p></div></div></div></div><div class="widget"><h3 class="widget-title">分类</h3><div class="widget-body"><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/51%E5%8D%95%E7%89%87%E6%9C%BA/">51单片机</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/arduino/">arduino</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">学习笔记</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%90%AC%E8%BF%90/">搬运</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%95%99%E7%A8%8B/">教程</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%99%BA%E8%83%BD%E8%BD%A6/">智能车</a><span class="category-list-count">2</span></li></ul></div></div><div class="widget"><h3 class="widget-title">标签云</h3><div class="widget-body tagcloud"><a href="/tags/51/" style="font-size:13.5px">51</a> <a href="/tags/51%E5%8D%95%E7%89%87%E6%9C%BA/" style="font-size:13px">51单片机</a> <a href="/tags/C%E8%AF%AD%E8%A8%80/" style="font-size:13px">C语言</a> <a href="/tags/OpenMv/" style="font-size:13.5px">OpenMv</a> <a href="/tags/arduino/" style="font-size:13.5px">arduino</a> <a href="/tags/diy/" style="font-size:14px">diy</a> <a href="/tags/git/" style="font-size:13.5px">git</a> <a href="/tags/typora/" style="font-size:13.5px">typora</a> <a href="/tags/%E5%AE%9E%E9%AA%8C/" style="font-size:13px">实验</a> <a href="/tags/%E6%95%99%E7%A8%8B/" style="font-size:14px">教程</a> <a href="/tags/%E6%98%9F%E8%BD%A8/" style="font-size:13px">星轨</a> <a href="/tags/%E7%94%B5%E8%B7%AF/" style="font-size:13px">电路</a></div></div><div class="widget"><h3 class="widget-title">最新文章</h3><div class="widget-body"><ul class="recent-post-list list-unstyled no-thumbnail"><li><div class="item-inner"><p class="item-category"><a class="category-link" href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">学习笔记</a></p><p class="item-title"><a href="/2022/01/10/51%E5%8D%95%E7%89%87%E6%9C%BA%E7%9A%84%E5%BB%B6%E6%97%B6%E5%87%BD%E6%95%B0/" class="title">51单片机的延时函数</a></p><p class="item-date"><time datetime="2022-01-10T04:20:30.000Z" itemprop="datePublished">2022-01-10</time></p></div></li><li><div class="item-inner"><p class="item-category"><a class="category-link" href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">学习笔记</a></p><p class="item-title"><a href="/2021/12/13/2021%E7%94%B5%E8%B5%9B%E6%80%BB%E7%BB%93/" class="title">2021电赛总结</a></p><p class="item-date"><time datetime="2021-12-13T15:10:08.000Z" itemprop="datePublished">2021-12-13</time></p></div></li><li><div class="item-inner"><p class="item-category"><a class="category-link" href="/categories/51%E5%8D%95%E7%89%87%E6%9C%BA/">51单片机</a></p><p class="item-title"><a href="/2021/11/29/%E4%BD%BF%E7%94%A851%E5%8D%95%E7%89%87%E6%9C%BA%E9%A9%B1%E5%8A%A8%E8%9C%82%E9%B8%A3%E5%99%A8%E6%92%AD%E6%94%BE%E9%9F%B3%E4%B9%90/" class="title">使用51单片机驱动蜂鸣器播放音乐</a></p><p class="item-date"><time datetime="2021-11-29T15:49:50.000Z" itemprop="datePublished">2021-11-29</time></p></div></li><li><div class="item-inner"><p class="item-category"></p><p class="item-title"><a href="/2021/11/28/%E6%9C%89%E9%99%90%E5%B7%AE%E5%88%86%E6%B3%95%E5%A4%84%E7%90%86%E7%94%B5%E7%A3%81%E5%9C%BA%E9%97%AE%E9%A2%98/" class="title">有限差分法处理电磁场问题</a></p><p class="item-date"><time datetime="2021-11-28T16:00:00.000Z" itemprop="datePublished">2021-11-29</time></p></div></li><li><div class="item-inner"><p class="item-category"><a class="category-link" href="/categories/%E6%90%AC%E8%BF%90/">搬运</a></p><p class="item-title"><a href="/2021/11/25/mini-macintosh-plus-%E5%9F%BA%E4%BA%8EESP32/" class="title">mini Macintosh plus(基于ESP32)</a></p><p class="item-date"><time datetime="2021-11-25T12:54:21.000Z" itemprop="datePublished">2021-11-25</time></p></div></li></ul></div></div><div class="widget"><h3 class="widget-title">备案信息</h3><div class="widget-body"><div id="board"></div><a class="text-color" href="https://beian.miit.gov.cn" target="_blank">皖ICP备2021013478号</a></div></div></div></aside><main class="main" role="main"><div class="content"><article id="post-mini-macintosh-plus-基于ESP32" class="article article-type-post" itemscope itemtype="http://schema.org/BlogPosting"><div class="article-header"><h1 class="article-title" itemprop="name">mini Macintosh plus(基于ESP32)</h1><div class="article-meta"><span class="article-date"><i class="icon icon-calendar-check"></i> <a href="/2021/11/25/mini-macintosh-plus-%E5%9F%BA%E4%BA%8EESP32/" class="article-date"><time datetime="2021-11-25T12:54:21.000Z" itemprop="datePublished">2021-11-25</time> </a></span><span class="article-category"><i class="icon icon-folder"></i> <a class="article-category-link" href="/categories/%E6%90%AC%E8%BF%90/">搬运</a> </span><span class="article-tag"><i class="icon icon-tags"></i> <a class="article-tag-link-link" href="/tags/diy/" rel="tag">diy</a> </span><span class="post-comment"><i class="icon icon-comment"></i> <a href="/2021/11/25/mini-macintosh-plus-%E5%9F%BA%E4%BA%8EESP32/#comments" class="article-comment-link">评论</a></span></div></div><div class="article-entry marked-body" itemprop="articleBody"><blockquote><p>参考：<a target="_blank" rel="noopener" href="https://spritesmods.com/?art=minimacplus">Sprites mods - Miniature Macintosh Plus - Intro</a></p></blockquote><h1 id="Intro"><a href="#Intro" class="headerlink" title="Intro"></a>Intro</h1><img src="https://spritesmods.com/minimacplus/mac_teaser.png" alt="img"><p>Back in the early days of computing, there was a company called Apple. They just had great success with their Apple II line of computers, but needed to innovate to stay on top of the quickly-developing computer scene. They already were working on the Lisa line of computers, a minicomputer-inspired beast intended for business users and priced as such, but that was deemed too expensive for the average customer. As a secondary project, the Macintosh was developed, initially with the idea in mind to make a new generation of computer for ‘the man on the street’ which should cost about $500. Steve Jobs got put on the project, and under him the hardware got more advanced,the software got a GUI instead of a text interface, and the price ballooned into almost $2500. Although the hardware you got for this price was slightly underwhelming, lacking e.g. the graphics accelerators and hardware sound capabilities other machines had, the software made more than up for it. This first Macintosh was the Mac 128K and its succes spurned more advanced models of this compact Mac, namely the Macintosh 512K, the Macintosh Plus, and the Macintosh SE-series.</p><p>While the development of the Macintosh happened around 1984, way before I was at an age I could understand computers, I do feel some kind of kinship with the compact Macintosh: the first computer my parents owned was a Macintosh Plus. It was later joined by a 20MB SCSI hard disk, and on that machine I wrote my first Basic-programs. Back when I still lived in the Netherlands, I actually bought a broken SE/30 machine and <a target="_blank" rel="noopener" href="http://spritesmods.com/?art=macsearm">converted</a> that into a Linux-server while still being able to run Mac-software. I left that machine in the Netherlands, however, and here in Shanghai, I have no classic Apple hardware anymore.</p><p>While obviously I don’t really need a Mac Plus anymore for my day-to-day life, I did like the idea of having one available for when I felt nostalgic. Maybe I could get a tiny bit of the Macintosh experience back by building a small one myself. Seeing I already have some experience with <a target="_blank" rel="noopener" href="https://hackaday.com/2016/11/28/tiniest-game-boy-hides-in-your-pocket/">making smaller versions of old hardware</a>, why not try to apply that process to the venerable Mac Plus as well?</p><h1 id="Display"><a href="#Display" class="headerlink" title="Display"></a>Display</h1><p>So, what to use when building something like this? One of the ways that sprung to mind was to take a Raspberry Pi or something, add a 2.5” LCD, add an emulator like PCE or MiniVMac, 3d-print an enclosure and call it a day. But I didn’t feel that would do my idea justice: not only would it be too big for my tastes, it also would be too easy: With the original Mac 128K, even while the end result was seen as underpowered, the hardware designers that built it did their best to pull a few nice tricks to save cost. Just assembling off-the-shelf commodity hardware into a replica felt like I would be doing the original design a disservice. So off to Taobao for some more exotic components I went!</p><p><img src="https://spritesmods.com/minimacplus/oled_taobao.png" alt="img"></p><p>I decided to start with the display. The Mac had a fairly high-resolution display for its time, and finding a display to replicate that had a pretty high priority. In general, when it comes to displays available on the Chinese electronic market, there’s a large choice available. Unfortunately, the ‘large choice’ seems to consist of either higher-resolution but larger screens, or alternatively tiny but lower-resolution screens. Ideally, I needed a resolution of 512x342 pixels; that is the native Mac resolution and on a screen like that, I would be able to display everything without rescaling. Unfortunately, screens with this resolution don’t readily exist; the next best resolution up would be something like 640x480. Screens with that resolution, for some reason, tend to start out pretty big: the smallest viable one I could find was about 3.5”. So unfortunately, I would have to do some downscaling if I wanted to make the Mac as small as possible.</p><p>After deciding it would be okay to downscale a bit, I had access to a fair amount more displays. One of the displays that popped up pretty quickly was the x163qln01, an 1.63” OLED screen made by AUO. While slightly expensive (about US$25 per screen), this display has good availability on Taobao and a datasheet that at least documents the pinouts, dimensions and power source requirements. This display seems to be made for certain Android smartwatches, and with some mangling of search terms, Google even spat out some initialization sequences I could use.</p><p>The only problem (well, aside from the connector that had pins a mere 0.5mm apart) was that the display did not use a parallel or SPI interface, but a MIPI interface. I’d have to tackle that later on.</p><p>With the choice of display made, I could move on to the processor. I grabbed an ESP32-Wrover module for this. This module contains an ESP32 (a WiFi chip with 2 32-bit CPUs running at 240MHz and about half a megabyte of RAM), 4MiB of flash and 4MiB of PSRAM memory. My guess was that the 2 CPU cores would be fast enough to emulate a Mac and that I could use the 4MiB of PSRAM memory to give the Mac its RAM. While 4MiB of flash is not that much, it should be enough for the emulator plus a small-ish hard disk with the system software and some programs. Also, it helps that I work for Espressif, making me pretty familiar with the hardware; what also helped was that I could just grab some modules from work instead of having to buy them and then wait for them to arrive.</p><p>With that, I was mostly set - the OLED still needed some components to be powered so the component count was increased by some LDO and other power supply chips. The Mac also needed sound so I sourced a cheap amplifier chip and speaker, and for power and debugging I pulled a common FT232 module out of a drawer somewhere. All these components are pretty small and allow me to scale down the enclosure, resulting in a model that would be a little bit bigger than 1/6th of a real Mac.</p><h1 id="Driving-the-display"><a href="#Driving-the-display" class="headerlink" title="Driving the display"></a>Driving the display</h1><p>While I had nothing to complain about the resolution, size and brightness of the display, actually getting pixels to it was more problematic. The MIPI interface it has was not supported by the ESP32 silicon so I would have to find another way to interface with it. The MIPI DSI interface is a standard developed by the <a target="_blank" rel="noopener" href="https://mipi.org/">MIPI Alliance</a> and not public; as a hobbyist, I’d have to piece together the details from leaked documents and probing of existing devices. Luckily, a year or two ago <a target="_blank" rel="noopener" href="http://www.electricstuff.co.uk/">Mike Harrison</a> reverse engineered the MIPI DSI interface used to control iPod displays (<a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=7TedIzmguP0">1</a>, <a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=IIR1Bw8T_vM">2</a>, <a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=YYadGWR3Xuo">3</a>, <a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=dPzeEw3zVwQ">4</a>, <a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=5gvO8-bGMpI">5</a>, <a target="_blank" rel="noopener" href="http://www.electricstuff.co.uk/nanohack.html">website</a>) and also managed to find some copies of the specifications. This made my life a lot easier: it helps to at least know what to send to the display.</p><p>While there is a lot more to it (and you should really watch the above videos if you want to know what), the physical layer of the MIPI protocol is pretty simple to explain. The MIPI protocol uses four wires in total: two data- and two clock-lines. The MIPI protocol has two modes of signalling: Low Power (LP) mode and High Speed (HS) mode.</p><p>​ <a target="_blank" rel="noopener" href="https://spritesmods.com/minimacplus/mipi_signal.png"><img src="https://spritesmods.com/minimacplus/mipi_signal-tmb.png" alt="img"></a></p><p>In Low Power mode, the wires are used separately to transmit some control data structures as well as indicate certain commands that have direct effect on the physical receiver on the other side. The voltage swing in this mode is pretty large compared to the high speed mode: voltages are either around 1.2 volt for a high signal, or around 0 volt for a low signal. Because low speed mode has more signal states, it does things like tell the receiver to enter or exit high speed mode. In the diagram above, the blue lines indicate Low Power communication.</p><p>In High Speed mode, the two clock lines (CLKP/CLKN) as well as the two data lines (DP/DN) work as differential lines, with one line always being the opposite as the other one. The receiver detects the difference between the two lines, and deduces the value being sent from this: a 1 if DP is higher, a 0 if DN is higher. High-speed mode, as the name implies, allows for very quick data transfers with clocks up to 1.5GHz. The trick the standard used to get this done without too much EMC and power use is to use very low voltages in this mode: the voltages on the pairs average to about 200mV, with variations of +/- 100mV per line to indicate the ones and zeroes. In the above diagram, the red bits are done in high-speed mode.</p><p>For the actual data transfer, in high speed mode the interface can essentially be seen as a somewhat weird and differential SPI interface: there is a clock and data path, and every clock tick, the value of the data is clocked into the interface. A change from SPI, apart from the fact that the signals are differential, is that a data bit is clocked in whenever the CLK lines change state, instead of only on e.g raising edges. Another difference is that the start of a transfer is detected not by a /CS line going low, but by in-band signalling: every transmission starts with one unique binary ‘magic word’ and the receiver detects this value to decide when a transmission starts.</p><p>In order to interface this with the ESP32, I’d have to do some level shifting. I wanted to run the ESP32 from a 3.0V power source, so all GPIOs would also be 3.0 or 0 volt. To adapt this to the signal levels of the MIPI interface, I opted for the most cheap solution: just use some resistor divider networks.</p><p>To figure out the resistor values, I effectively made equations for the three voltage output states that interested me (1.1V for Low Power high, 0.07V for High Speed low, 0.33V for High Speed high; voltages chosen to stay in-spec for most situations) and the three input states that should generate them. Using some math, I ended up at some equations. I could theoreticaly work out those equations by hand, but eventually decided to throw them into <a target="_blank" rel="noopener" href="https://www.wolframalpha.com/">WolframAlpha</a> which gave me the needed resistor values.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">           3V</span><br><span class="line">G -R1--+   R3</span><br><span class="line">G -R2--+ --+----&gt;</span><br><span class="line">           R4</span><br><span class="line">           GND</span><br><span class="line"></span><br><span class="line">R4*(1.9/R1+1.9/R3)=1.1, </span><br><span class="line">(1/(1/R4+1/R1+1/R2))*(2.93/R3)=0.07, </span><br><span class="line">(1/(1/R4+1/R1))*2.67*(1/R3+1/R2)=0.33, </span><br><span class="line">R2=1000</span><br><span class="line"></span><br><span class="line">R1=280, R2=1K, R3=3K6, R4=150</span><br></pre></td></tr></table></figure><p>At that time, I figured I could also cheat a bit: because the lines are differential in high-speed mode, the display will only look at the difference between the two lines to deduce the data sent. This means that I can save a GPIO by holding one of the lines at a fixed voltage, making the other line higher and lower as needed. To do this, I needed a second type of resistor network:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">           3V</span><br><span class="line">           R3</span><br><span class="line">G -R1--+ --+----&gt;</span><br><span class="line">           R4</span><br><span class="line">           GND</span><br><span class="line"></span><br><span class="line">R4*(1.9/R1+1.9/R3)=1.1,</span><br><span class="line">(1/(1/R4+1/R1))*(2.8/R3)=0.2,</span><br><span class="line">R4=150</span><br><span class="line"></span><br><span class="line">R1=320, R3=1500, R4=150</span><br></pre></td></tr></table></figure><p>Another thing to solve was the clocking scheme. Normal SPI clocks in a bit on a raising edge of the clock line. (Or a falling one, depending on the configuration.) MIPI clocks in a bit on both the raising as well as the falling edge of the clock signal. While the ESP32s hardware SPI unit cannot by itself generate a signal like this, we can convert from one to another by using a simple D-type flipflop with its inverted output connected to its input. Every clock pulse on the input will change the level of the output, exactly as is needed here.</p><h1 id="Schematic"><a href="#Schematic" class="headerlink" title="Schematic"></a>Schematic</h1><p>With the display hardware fixed up, the hardest part of the hardware design was done. Now we only need to add the rest. First up, the power supply. This is pretty simple: I feed the entire design from 5V from an USB-to-serial converter that I also can use as a debugging/programming interface. That voltage is taken to generate the +4.6V, -3.4V and 1.8V the OLED screen needs, as well as the 3.0V to feed the ESP32. The +4.6V and -3.4V are generated by a TPS65631 chip, and a reference schematic for that was included in the datasheet for thr OLED. The other voltages are generated by a pair of simple LDOs.<br><a target="_blank" rel="noopener" href="https://spritesmods.com/minimacplus/schematic_oledpsu.png"><img src="https://spritesmods.com/minimacplus/schematic_oledpsu-tmb.png" alt="img"></a></p><p>The Macintosh also had sound. The quality isn’t that good by modern standards (22KHz, 8-bit) but the sounds that various software programs make are by now quite iconic, so I couldn’t forego a speaker here. The ESP32 has a built-in 8-bit DAC, and that is used to render the analog soundwaves that the emulator generates. That then gets put into a NS8002 which is a 2W class-AB audio amplifier housed in a small SOIC8 package. It is cheap, needs very few support components and makes more than enough noise for the tiny Mac to attract attention.<br><a target="_blank" rel="noopener" href="https://spritesmods.com/minimacplus/schematic_audio.png"><img src="https://spritesmods.com/minimacplus/schematic_audio-tmb.png" alt="img"></a></p><p>One of the things that made the Macintosh so revolutionary is that it was one of the first commercial computers that came with a mouse. The Macintosh team thought so highly of the mouse that essentially the entire OS is based around mouse-controlled UI elements, and unlike, for example, an IBM PC, it is entirely possible to control the entire Macintosh with only a mouse. Obviously, my tiny Mac should also have such an important peripheral. I still do remember the original ball mouse that came with the early Macintoshes, and I do not quite relish the need to get the gunk off the little rollers every so often; there is a reason optical mice have replaced these mechanical devices entirely. This also has the advantage that parts for these new-fangles optical mice are quite easy to obtain: I did not need to spend much effort at all to locate a source of ADNS9500 gaming mouse sensors plus the corresponding optics, for instance.</p><p>The other nice thing is that an optical mouse sensor is a pretty deeply integrated device: a mouse sensor only needs a few other external components to function, and the schematic reflects this. There are a few capacitors for voltage stabilization, an MOSFET (copied straight from the datasheet) to switch the laser diode, and some other jellybean parts. The mouse sensor communicates using a four-wire SPI signal, and I’ve re-used one of these wires to also send the mouse button signal over: the MISO pin is pulled down with a fairly strong pulldown when this button is pressed. The value of this pulldown resistor is not enough to stop the mouse sensor from communicating, but it is enough to overcome the pullup-resistor that normally pulls up the line, so when the sensor tristates the MISO line, the ESP32 can detect if the button is pressed.<br><a target="_blank" rel="noopener" href="https://spritesmods.com/minimacplus/schematic_mouse.png"><img src="https://spritesmods.com/minimacplus/schematic_mouse-tmb.png" alt="img"></a></p><p>Finally, the OLED screen needs connecting. We already did all the hard work calculating all the resistor values, so the schematic should be more or less self-explanatory. The chip added is a D-type flipflop and is used to halve the clock rate: as mentioned before the MIPI standard needs a new data bit every time the clock polarity inverts, while the ESP32 can only send out a new one on a raising or falling edge.<br><a target="_blank" rel="noopener" href="https://spritesmods.com/minimacplus/schematic_oledclkdata.png"><img src="https://spritesmods.com/minimacplus/schematic_oledclkdata-tmb.png" alt="img"></a></p><p>With the schematic drawn, I moved on to the PCB artwork. The display I chose was meant to be mounted to its controlling PCB, with the connector on the backside of that PCB. While that would not leave much room for the other components, I still wanted to put all the other components on the other side.<br><a target="_blank" rel="noopener" href="https://spritesmods.com/minimacplus/pcbs_empty.jpg"><img src="https://spritesmods.com/minimacplus/pcbs_empty-tmb.jpg" alt="img"></a></p><p>It’s a good thing I have a good pair of eyes and a hot-air rework station: this allowed me to use 0603 components which made everything fit cleanly on the limited PCB space. Especially the connector for the display and the QFN OLED power supply chip would be pretty hard to do with a normal soldering iron.</p><p>​ <a target="_blank" rel="noopener" href="https://spritesmods.com/minimacplus/pcb_populated.jpg"><img src="https://spritesmods.com/minimacplus/pcb_populated-tmb.jpg" alt="img"></a></p><p>For the mouse sensor and attached components, I figured out using a PCB would use up too much space. Instead, I opted to solder all components on the sensor itself, freeform style. This way, everything should be able to fit in the mouse.</p><p>​ <a target="_blank" rel="noopener" href="https://spritesmods.com/minimacplus/mousesensor.jpg"><img src="https://spritesmods.com/minimacplus/mousesensor-tmb.jpg" alt="img"></a></p><h1 id="Software"><a href="#Software" class="headerlink" title="Software"></a>Software</h1><p>​ <a target="_blank" rel="noopener" href="https://spritesmods.com/minimacplus/mac_poster.jpg"><img src="https://spritesmods.com/minimacplus/mac_poster-tmb.jpg" alt="img"></a></p><p>Now obviously, the software is a fairly big element of this build: the entire Macintosh needs to be emulated. The Macintosh, however, is not that complicated a machine. It essentially consists of the 68000 microcontroller, a Zilog Z8530 serial communications controller that controls the serial port, a 6522 VIA for some internal input and output and for interfacing with the keyboard and some random PALs containing the logic for the display and sound. There also is an Integrated Woz Machine-chip to interface with the floppy drive. This is a fairly complicated chip; however I was not planning to emulate a floppy so for emulation it would be enough to emulate an IWM that always returns that there’s no floppy in the drive. Instead, my plan was to fully emulate the NCR 5380 SCSI chip, connected to an emulated SCSI hard disk that would read from the onboard flash of the ESP32-Wrover module.</p><p>Furthermore, there are very few programs that attempt to access this hardware directly: programmers for the Mac were told from the start to use the OS-level hardware abstraction layers in order to stay compatible with later versions of the Mac hardware. In general, this means that when I succeeded emulating the hardware to a standard where the OS boots and stays happy, most programs would also run without complaints.</p><p>Because of this I decided I might as well program the emulator from scratch. Well, not entirely from scratch; the 68000 is a fairly complex beast and I didn’t feel like reinventing <em>that</em> particular wheel. Instead, I looked around on the Internet, and <a target="_blank" rel="noopener" href="http://mamedev.org/">MAME</a> had a nice and quick C-based 68K emulator called Musashi that fit the bill nicely. It needed some slight mangling to put the lookup tables for the opcodes into flash instead of RAM, but otherwise it didn’t need much to port to the ESP32.</p><p>However, I wasn’t planning on developing the entire thing on the ESP32: while the chip has OpenOCD support allowing for a fair amount of debugging, the upload/test/fix/upload/… cycle would get pretty tedious. Instead, I decided to develop the thing on my Linux-machine first, keeping in mind the limits the ESP32 would eventually give me. So I went to work, using the datasheets for the various chips, the <a target="_blank" rel="noopener" href="http://www.mac.linux-m68k.org/devel/plushw.php">Linux-68K</a> notes for the machine, as well as bits and pieces of the Inside Macintosh series that were floating around on the Internet. When I couldn’t find out from these what to do, I still had the option to sneak a peek under the hood of <a target="_blank" rel="noopener" href="http://www.gryphel.com/c/minivmac/">other</a> <a target="_blank" rel="noopener" href="http://www.hampa.ch/pce/pce-macplus.html">open-source</a> <a target="_blank" rel="noopener" href="http://www.mess.org/mess/drivers/mac/macplus">emulators</a>.</p><p>Armed with all that, gcc as the C-compiler and libsdl as the library to get graphics going, I set to work. Long story short, some time later I ended up having a basic but mostly functional MacPlus emulator: mouse, video, SCSI hard disk and sound all worked:<br><a target="_blank" rel="noopener" href="https://spritesmods.com/minimacplus/tme_booted.png"><img src="https://spritesmods.com/minimacplus/tme_booted-tmb.png" alt="img"></a></p><p>Because my hardware wasn’t done yet, I decided to port my emulator to an ESP-Wrover-Kit devboard. I had access to a few of these boards anyway, and apart from the Wrover module I was going to use anyway, it also had a nice 320x240 display I could use to see if video works.<br><a target="_blank" rel="noopener" href="https://spritesmods.com/minimacplus/mac_wroom.jpg"><img src="https://spritesmods.com/minimacplus/mac_wroom-tmb.jpg" alt="img"></a></p><p>After some tweaking, the Mac emulator actually ran fairly well on this board; it usually comes pretty close to the 7.8MHz the Mac Plus normally runs at. (Actually, 7.8MHz would be slightly faster than a Mac Plus; because the frame buffer and sound system in the real thing eat up some of the memory cycles, the actual effective frequency could be as much as 35% lower.)</p><p>Obviously, getting the emulator working on a devboard is a nice step along the way, but in the end, the thing needs to run on the screen that I bought, not the devboard screen. And hold on a second, the devkit screen is 320x240 and cuts off a fair chunk of the Mac screen. The display I intend to use is 320x320 and as such only larger vertically: how am I going to get the 512x342 Mac screen displayed on it?</p><p>There’s one way to put 512x342 pixels onto a 320x320 screen, and that is scaling. Effectively, you take an image, then squish it to make it smaller, then you display it. However, scaling can be done in multiple ways and especially with a black-and-white image generated by an OS that assumes every pixel it set results in a clearly distinguishable point of light on the screen, there are multiple ways to do it badly. Effectively, I would like to lose as little resolution as possible. This means I needed to increase the resolution of my OLED.</p><p>But how do you do that? I can hardly open up the OLED screen and squish some more pixels in there. However, I don’t need to; the OLED display already has three times as many pixels as advertised. The reason for this is that the OLED screen is a color one: for each virtual ‘pixel’, it has a red, a green and a blue subpixel. Additionally, in this specific screen, the subpixels are laid out in triangles. To illustrate this, here’s a close-up of the screen, with three pixels lit:<br><a target="_blank" rel="noopener" href="https://spritesmods.com/minimacplus/pixels.jpg"><img src="https://spritesmods.com/minimacplus/pixels-tmb.jpg" alt="img"></a></p><p>As you can see, the pixels are triangle-shaped sets of three subpixels; depending on the column they are on, the triangles either point up or down. This effectively means that our subpixel screen resolution is a nice 480 x 640 pixels instead. While still not entirely adequate for displaying 512x342 pixels, the difference is so small that with a small bit of well-chosen scaling the display looks as readable as an 1.63” display showing a GUI meant for a 9” screen will ever be:<br><a target="_blank" rel="noopener" href="https://spritesmods.com/minimacplus/disp_scaled.jpg"><img src="https://spritesmods.com/minimacplus/disp_scaled_tmb.jpg" alt="img"></a></p><h1 id="Enclosure"><a href="#Enclosure" class="headerlink" title="Enclosure"></a>Enclosure</h1><p>So now I had a display, software that could emulate a Macintosh Plus fairly well, plus a microcontroller it could run on. What’s still missing? A nice box to put it in, obviously!</p><p>I decided to 3d-print one on the nice Formlabs 1+ SLA printer my work has. To do this, I first needed a model. I wanted to build one from scratch. Obviously, to do this it would be best if I had a real Macintosh Plus at my disposal. I actually have one in my posession, but it was half a continent away… Luckily, I could get my hands on the next best thing: some kind soul uploaded the dimensions of an original Mac 128K (which has almost the same case as the Plus) to the <a target="_blank" rel="noopener" href="https://www.ifixit.com/Wiki/Macintosh_128K_Dimensions">iFixit</a> wiki.</p><p>I still do all my 3d modeling in OpenScad, and after some sweating and cursing to get all the curves looking like they should, I had a nice model of an 1-to-6-scale Mac. <a target="_blank" rel="noopener" href="https://spritesmods.com/minimacplus/scad.jpg"><img src="https://spritesmods.com/minimacplus/scad-tmb.jpg" alt="img"></a></p><p>The mouse was also created from the iFixit images, but because it needed to fit the (relatively large) optical mouse sensor, unfortunately it couldn’t be scaled to 1/6th of the real thing. The scale is more like 2/5th, making it seem somewhat large next to the tiny Mac but also making it way more usable for non-scaled-down human fingers.</p><p><a target="_blank" rel="noopener" href="https://spritesmods.com/minimacplus/scad_mouse.png"><img src="https://spritesmods.com/minimacplus/scad_mouse-tmb.png" alt="img"></a></p><p>So now all that remained was to print the thing. I exported the design as various STL files and used the Formlabs 1+ to print them. This went fairly well, althought the resin was somewhat old so I put a few more supports than the default in to make sure I wouldn’t get a mis-print. The end result came out pretty nice; the only regret I have is that I didn’t put locking clips for the two halves in the design. I eventually worked around that by just sealing the two halves together using a drop of superglue.<br><a target="_blank" rel="noopener" href="https://spritesmods.com/minimacplus/case_done.jpg"><img src="https://spritesmods.com/minimacplus/case_done_tmb.jpg" alt="img"></a></p><h1 id="Result"><a href="#Result" class="headerlink" title="Result"></a>Result</h1><p>So, I had all the parts and I just needed to click them together. The PCB slots in the front of the case, where a few clips hold it in. The usb-to-serial converter, used as an upload mechanism and a power supply, slot into the back bit and is also held by a few clips. I forgot to make something to hold the speaker in, but some superglue can easily affix it inside the case. Finally, the mouse is connected using a bundle of thin wires. (And yes, they kind-of clash with the color scheme… as soon as I find a nicer, thin multi-core cable I’ll replace it with that.)</p><p><a target="_blank" rel="noopener" href="https://spritesmods.com/minimacplus/done.jpg"><img src="https://spritesmods.com/minimacplus/done-tmb.jpg" alt="img"></a></p><p>Now, when designing things on a computer in order to have them materialize in full later on, like what happens when you finally receive those PCBs from the factory or when your 3d-printer finishes printing that design you worked for weeks on, is the scale of the thing. Obviously, I knew that all sizes would be 1/6th of a real Mac, but only when everything was put together and I saw the thing in real life, the implications of this showed. The Mac truly is tiny!<br><a target="_blank" rel="noopener" href="https://spritesmods.com/minimacplus/tiny.jpg"><img src="https://spritesmods.com/minimacplus/tiny_tmb.jpg" alt="img"></a><a target="_blank" rel="noopener" href="https://spritesmods.com/minimacplus/mac_full2.jpg"><img src="https://spritesmods.com/minimacplus/mac_full2_tmb.jpg" alt="img"></a></p><p>And even with its minute size and lack of a keyboard, it does run most of the things the Mac is well-known for. Here is a demonstration. The first 20 seconds are the memory test, and I know from experience the test lasting this long is not a bug: it took our original Mac Plus that long to boot as well after we upgraded it.</p><p>So, what good is this Mac Plus in the end? Admittently, while I had a blast making it, without a keyboard it can’t really serve a real purpose. Also, it has no connectivity to speak of: I planned to make it do AppleTalk over WiFi, but I failed because of some weirdnesses I couldn’t emulate right in the serial controller chip of the original Mac. Still, with the project finished in the state it is, I can finally live my lifelong dream to have a Mac on my desk displaying the original After Dark flying toasters:<br><img src="https://spritesmods.com/minimacplus/toaster-optimized.gif" alt="img"></p><p>As always, this project is open-source, and the PCB artwork as well as the case design and the firmware are up on <a target="_blank" rel="noopener" href="https://github.com/Spritetm/minimacplus">Github</a>. Everything is licensed under the Beer-Ware license so you can mostly do with it what you want. If you ever use it in something, I’d really appreciate a [note](<a target="_blank" rel="noopener" href="http://spritesmods.com/?art=contact&amp;af=Miniature">http://spritesmods.com/?art=contact&amp;af=Miniature</a> Macintosh Plus), however.</p></div><div class="article-footer"><div class="panel panel-default panel-badger"><div class="panel-body"><figure class="media"><div class="media-left"><a href="https://github.com/0clock" target="_blank" class="img-burn thumb-sm visible-lg"><img src="/images/avatar.jpg" class="img-rounded w-full" alt=""></a></div><div class="media-body"><h3 class="media-heading"><a href="https://github.com/0clock" target="_blank"><span class="text-dark">&#39; J &#39;</span><small class="ml-1x">生命在于折腾</small></a></h3><div>Geek</div></div></figure></div></div></div></article><section id="comments"><div id="vcomments"></div></section></div><nav class="bar bar-footer clearfix" data-stick-bottom><div class="bar-inner"><ul class="pager pull-left"><li class="prev"><a href="/2021/11/28/%E6%9C%89%E9%99%90%E5%B7%AE%E5%88%86%E6%B3%95%E5%A4%84%E7%90%86%E7%94%B5%E7%A3%81%E5%9C%BA%E9%97%AE%E9%A2%98/" title="有限差分法处理电磁场问题"><i class="icon icon-angle-left" aria-hidden="true"></i><span>&nbsp;&nbsp;上一篇</span></a></li><li class="next"><a href="/2021/11/24/%E9%94%82%E7%94%B5%E6%B1%A0%E7%94%B5%E5%8E%8B%E6%B5%8B%E9%87%8F%E7%94%B5%E8%B7%AF%E8%AE%BE%E8%AE%A1/" title="锂电池电压测量电路设计"><span>下一篇&nbsp;&nbsp;</span><i class="icon icon-angle-right" aria-hidden="true"></i></a></li></ul><div class="bar-right"></div></div></nav></main><footer class="footer" itemscope itemtype="http://schema.org/WPFooter"><ul class="social-links"><li><a href="https://github.com/0clock" target="_blank" title="Github" data-toggle="tooltip" data-placement="top"><i class="icon icon-github"></i></a></li><li><a href="/atom.xml" target="_blank" title="Rss" data-toggle="tooltip" data-placement="top"><i class="icon icon-rss"></i></a></li></ul><div class="copyright"><a href="https://beian.miit.gov.cn/" target="_blank"><svg width="1rem" height="1rem" xmlns="http://www.w3.org/2000/svg" name="zi_icp" viewBox="0 0 2000 2000"><path d="M897 1979q15 0 30-2 7-1 42.5-9.5t91-29.5q55.5-21 123.5-59t139-97.5q71-59.5 137.5-144t119.5-199q53-114.5 84.5-262.5t31.5-336V583q0-69-57-121-55-44-127-41-5 1-45 1-34 0-92.5-4T1254 401q-57-15-116.5-53.5T1036 276q-28-22-45-33-43-25-93.5-25T803 244q-2 1-14 11-90 78-151 109.5T548 401q-63 13-122 17t-93 4q-38 0-45-1-73-4-127 41-57 52-57 121v257q0 188 31 336.5t84 262.5q53 114 118.5 199T474 1782q71 59 138.5 97t123 59q55.5 21 90.5 30t42 9q15 2 29 2zM277 540h5q8 1 51 1 38 0 104-4t137-20q134-30 295-174 14-7 30.5-6t29.5 8q5 3 14 10t20 15l1 1q48 38 118 82.5t145 63.5q72 16 137.5 20t102.5 4q43 0 51-1h5q21 0 38 13 15 14 15 30v257q0 169-27 302t-73 236q-46 103-104 178.5T1252 1685q-62 53-121 87t-107.5 52.5q-48.5 18.5-79 26.5t-36.5 8q-11 2-21 0-7 0-45.5-10.5t-98-36q-59.5-25.5-129-73t-138.5-122Q407 1543 350 1435t-92-255q-35-147-35-340V583q0-16 15-29 17-14 39-14zm-77 207v104h1400V747H200zm184 194v476h99V941h-99zm528 311q-4 41-35 70-30 30-74 30-54 0-87-44-34-44-34-131 0-85 31-130 31-44 87-44 87 0 112 107l92-8q-14-81-69-125-54-43-136-43-104 0-164 68t-60 177q0 67 26 124 25 56 72 88 47 33 122 33 90 0 145-46t64-118l-92-8zm270 165v-189h137q78 0 128-40 51-41 51-106 0-57-47-99-46-42-143-42h-225v476h99zm0-262v-143h108q59 0 81 21 23 21 23 50 0 33-25 52-24 20-70 20h-117z"/></svg>皖ICP备2021013478号</a></div></footer><script src="//cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script><script>window.jQuery||document.write('<script src="js/jquery.min.js"><\/script>')</script><script src="/js/plugin.min.js"></script><script src="/js/application.js"></script><script>window.INSIGHT_CONFIG={TRANSLATION:{POSTS:"文章",PAGES:"页面",CATEGORIES:"分类",TAGS:"标签",UNTITLED:"(未命名)"},ROOT_URL:"/",CONTENT_URL:"/content.json"}</script><script src="/js/insight.js"></script><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//cdn.jsdelivr.net/npm/valine"></script><script type="text/javascript">var GUEST=["nick","mail","link"],meta=(meta="nick,mail,link").split(",").filter(function(e){return-1<GUEST.indexOf(e)});new Valine({el:"#vcomments",verify:!1,notify:!1,appId:"LoDnEJxBAoq2mcdMXdga6NRN-gzGzoHsz",appKey:"7H1CMHnV2JMKB55ByIb5rPUS",placeholder:"Just go go",avatar:"mm",meta:meta,pageSize:"10",visitor:!1})</script><script src="//cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.3.5/dist/jquery.fancybox.min.js"></script><script>$(document).ready(function(){$("article img").not("[hidden]").not(".panel-body img").each(function(){var a,t,n=$(this),e=n.attr("alt"),r=n.parent("a");r.length<1&&(-1!=(t=(a=this.getAttribute("src")).lastIndexOf("?"))&&(a=a.substring(0,t)),r=n.wrap('<a href="'+a+'"></a>').parent("a")),r.attr("data-fancybox","images"),e&&r.attr("data-caption",e)}),$().fancybox({selector:'[data-fancybox="images"]',hash:!1,loop:!1})})</script><style>.copy-btn{display:inline-block;padding:6px 12px;font-size:13px;font-weight:700;line-height:20px;color:#333;white-space:nowrap;vertical-align:middle;cursor:pointer;background-color:#eee;background-image:linear-gradient(#fcfcfc,#eee);border:1px solid #d5d5d5;border-radius:3px;user-select:none;outline:0}.highlight-wrap .copy-btn{transition:opacity .3s ease-in-out;opacity:0;padding:2px 6px;position:absolute;right:4px;top:8px;z-index:2}.highlight-wrap .copy-btn:focus,.highlight-wrap:hover .copy-btn{opacity:1}.highlight-wrap{position:relative}</style><script>addLoadEvent(()=>{
        $('.highlight').each(function (i, e) {
          var $wrap = $('<div>').addClass('highlight-wrap')
          $(e).after($wrap)
          $wrap.append($('<button>').addClass('copy-btn').append('复制').on('click', function (e) {
            var code = $(this).parent().find(".code")[0].innerText
            
            var ta = document.createElement('textarea')
            document.body.appendChild(ta)
            ta.style.position = 'absolute'
            ta.style.top = '0px'
            ta.style.left = '0px'
            ta.value = code
            ta.select()
            ta.focus()
            var result = document.execCommand('copy')
            document.body.removeChild(ta)
            
              if(result)$(this).text('复制成功')
              else $(this).text('复制失败')
            
            $(this).blur()
          })).on('mouseleave', function (e) {
            var $b = $(this).find('.copy-btn')
            setTimeout(function () {
              $b.text('复制')
            }, 300)
          }).append(e)
        })
      })</script></body></html>